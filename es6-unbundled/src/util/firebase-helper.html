<html><head><link rel="import" href="../bower_components/polymer/polymer.html"><script>Polymer.FirebaseHelper={_firebaseUpdateUserInfo:function(a){this.set('_channels',[]);a&&(this.offline&&(this.$.loading.hidden=!0),firebase.database().ref('/users/'+a.uid).once('value',function(b){var c=b.val();this.$.newPost.hidden=!1,this.$.newPost._emojify(),this.$.loading.hidden=!0,this.$.pages.hidden=!1,this._firebaseUpdatePublicChannels(),c?(console.log('Existing user:',this.user),!this.offline&&this._firebaseGetUserChannels(b.val().channels||[])):(console.log('New user!'),firebase.database().ref('/users/').child(a.uid).set({id:a.uid,name:a.displayName,email:a.email,photo:a.photoURL,createdAt:{".sv":'timestamp'}}))}.bind(this)))},_firebaseUpdatePublicChannels:function(){for(var a=this,b=0;b<this.publicChannels.length;b++)firebase.database().ref('/channels/'+this.publicChannels[b].$key).once('value',function(b){var c=b.val();b.val()&&(c.$key=c.key=b.key,a.set(['publicChannels',+this],c))}.bind(b))},_firebaseGetUserChannels:function(a){for(var b=this,c=0;c<a.length;c++)firebase.database().ref('/channels/'+a[c]).once('value',function(a){this._processOneChannel(a.key)}.bind(this))},_processOneChannel:function(a){firebase.database().ref('/channels/'+a).once('value',function(a){if(a.val()){var b=a.val();b.key=a.key,this.push('_channels',b)}}.bind(this))},_firebaseAddMessage:function(a,b,c,d){firebase.database().ref('/channelNames/'+a).once('value',function(a){var e=a.val().id,f=new Date().getTime();firebase.database().ref('/posts/').child(e).push({name:this.user.displayName,message:b,original:c,email:this.user.email,uid:this.user.uid,image:this.user.photoURL,likes:0,location:d,createdAt:f,index:-f})}.bind(this))},_firebaseLikeMessage:function(a,b){firebase.database().ref('/posts/'+b).child(a).once('value',function(a){var b=a.val().likes||0;a.ref.child('likes').set(b+1)})},_firebaseUnlikeMessage:function(a,b){firebase.database().ref('/posts/'+b).child(a).once('value',function(a){var b=a.val().likes||0;0!==b&&a.ref.child('likes').set(b-1)})},_firebaseDeleteMessage:function(a,b){firebase.database().ref('/posts/'+b).child(a).remove()},_firebaseAddChannel:function(a,b,c){var d=this;firebase.database().ref('/channelNames/'+a).once('value',function(e){if(e.val())d.$.newChannel.showError('Oops! This name is already taken.');else{d.$.newChannel.hide(),-1===b.indexOf(d.user.email)&&b.splice(0,0,d.user.email);var f={name:a,owner:d.user.uid,ownerEmail:d.user.email,users:0==b.length?null:b,public:c,createdAt:{".sv":'timestamp'}},g=firebase.database().ref('/channels/').push(f);if(f.key=g.key,c?firebase.database().ref('/publicChannels/').child(g.key).set({name:a}).then(function(a){this.set(['publicChannels',this.publicChannels.length-1],a)}.bind(d,f)):d.push('_channels',f),firebase.database().ref('/channelNames/').child(a).set({id:g.key}),c)return;firebase.database().ref('/users/'+d.user.uid).once('value',function(a){var b=a.val().channels||[];b.push(g.key),a.ref.update({channels:b})}),firebase.database().ref('/users/').once('value',function(a){var c=a.val();for(var e in c)if(c[e].email!==d.user.email&&-1!=b.indexOf(c[e].email)){var f=c[e].channels||[];f.push(g.key),firebase.database().ref('/users/'+e).update({channels:f})}})}})},_firebaseDeleteChannel:function(a,b){var c=this.$.pages.querySelector('view-posts.iron-selected');firebase.database().ref('/channelNames/').child(b).remove(),firebase.database().ref('/channels/').child(a).remove(),firebase.database().ref('/publicChannels/').child(a).remove(),this.$.newChannel.hide(),this.set('routeData.page','global'),c.ref===a&&Polymer.dom(this.$.pages).removeChild(c);for(var d=0;d<this.channels.length;d++)if(this.channels[d].name===b)return void this.splice('_channels',d,1)},_firebaseRenameChannel:function(a,b,c){var d=this;firebase.database().ref('/channelNames/'+c).once('value',function(e){e.val()?d.$.newChannel.showError('Oops! This name is already taken.'):firebase.database().ref('/channels/').child(a).update({name:c}).then(function(){firebase.database().ref('/channelNames/').child(b).remove(),firebase.database().ref('/channelNames/').child(c).set({id:a}),d.$.newChannel.hide();for(var e=0;e<d.channels.length;e++)if(d.channels[e].name===b)return void d.set(['_channels',e,'name'],c)},function(a){console.log(a),d.$.newChannel.showError('Permission denied. Are you sure you\'re allowed to do this?')})})},_firebaseAddUsers:function(a,b){this.$.newChannel.hide(),firebase.database().ref('/channels/'+a).once('value',function(a){var c=a.val().users;c=c.concat(b),a.ref.update({users:c})}),firebase.database().ref('/users/').once('value',function(c){var d=c.val();for(var e in d)if(-1!=b.indexOf(d[e].email)){var f=d[e].channels||[];f.push(a),firebase.database().ref('/users/'+e).update({channels:f})}})},_firebaseDeleteUsers:function(a,b){this.$.newChannel.hide(),firebase.database().ref('/channels/'+a).once('value',function(a){var c=a.val().users;for(var d in b){var e=c.indexOf(b[d]);-1!=e&&c.splice(e,1)}a.ref.update({users:c})}),firebase.database().ref('/users/').once('value',function(c){var d=c.val();for(var e in d)if(-1!=b.indexOf(d[e].email)){var f=d[e].channels||[],g=f.indexOf(a);f.splice(g,1),firebase.database().ref('/users/'+e).update({channels:f})}})}};</script></head><body></body></html>