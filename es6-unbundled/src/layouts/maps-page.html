<html><head><link rel="import" href="../../bower_components/polymer/polymer-element.html"><link rel="import" href="../../bower_components/google-map/google-map.html"><link rel="import" href="../../bower_components/geo-location/geo-location.html"><link rel="import" href="../../bower_components/paper-avatar/paper-avatar.html"><link rel="import" href="../../bower_components/paper-item/paper-icon-item.html"><link rel="import" href="../../bower_components/paper-fab/paper-fab.html"><link rel="import" href="../../bower_components/paper-item/paper-item.html"><link rel="import" href="../../bower_components/iron-icon/iron-icon.html"><link rel="import" href="../../bower_components/iron-icons/iron-icons.html"><link rel="import" href="../../bower_components/iron-icons/communication-icons.html"><link rel="import" href="../../bower_components/polymerfire/firebase-query.html"><link rel="import" href="../../bower_components/app-storage/app-network-status-behavior.html"><link rel="import" href="../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html"><link rel="import" href="../views/d2l-dropdown.html"><link rel="import" href="../views/profile-marker.html"><link rel="import" href="../views/d2l-dropdown-content.html"><link rel="import" href="../components/menu-sidebar.html"><link rel="import" href="../components/notification-manager.html"><link rel="import" href="../components/list-device.html"><link rel="import" href="../dialog/device-dialog.html"><link rel="import" href="../dialog/upload-image.html"><link rel="import" href="../util/firebase-device-helper.html"><link rel="import" href="../util/firebase-data-helper.html"><link rel="import" href="../util/unicode-sign-helper.html"></head><body><dom-module id="maps-page"><template><style>[hidden]{display:none !important;}:host{display:block;}google-map{margin:0;position:relative;height:100vh;width:100vh%;padding:0;}d2l-dropdown{position:absolute;right:30px;top:15px;}#menubar{position:absolute;z-index:10;top:0;left:0;margin:8px 0 8px 8px;max-height:90%;max-height:-webkit-calc(100% - 100px);max-height:-moz-calc(100% - 100px);max-height:-o-calc(100% - 100px);max-height:calc(100% - 100px);max-height:438px;height:50%;width:360px;}#sidebar{position:absolute;z-index:10;bottom:0;right:0;margin:8px 8px 0;max-height:50%;max-height:-webkit-calc(100% - 50%);max-height:-moz-calc(100% - 50%);max-height:-o-calc(100% - 50%);max-height:calc(100% - 50%);height:100%;width:360px;}#sidebar .sidebar-content{background:#fff;border-right:1px solid #d9d9d9;width:100%;height:100%;max-width:100%;}paper-avatar.red{--paper-avatar-color:red;}paper-avatar.large{--paper-avatar-width:32px;}.avatar{display:inline-block;box-sizing:border-box;width:40px;height:40px;border-radius:50%;background:var(--paper-amber-500);}paper-fab{position:absolute;bottom:1em;right:1em;}paper-fab.blue{--paper-fab-background:var(--primary-color);--paper-fab-keyboard-focus-background:var(--light-primary-color);}</style><firebase-query id="marker_query" app-name="[[appName]]" path="/map/markers" data="{{liveMarkersData}}"></firebase-query><app-indexeddb-mirror session="[[user.uid]]" key="/map/markers" data="[[liveMarkersData]]" persisted-data="{{persistedMarkersData}}"></app-indexeddb-mirror><notification-manager id="notifications"></notification-manager><device-dialog user="[[user]]" app-name="[[appName]]" id="deviceDialog" on-device-dialog-confirm="deviceConfirm" group-device="[[groupDevice]]"></device-dialog><geo-location latitude="{{latitude}}" longitude="{{longitude}}"></geo-location><google-map id="map" class="map" click-events="click-events" latitude="[[latitude]]" longitude="[[longitude]]" api-key="AIzaSyBIXx8WldBFaxm-2GhlA5Ix2JGfIypLTNg" zoom="12" disable-default-ui="disable-default-ui" on-google-map-ready="onMapReady" ongoogle-map-click="onMapClickx"></google-map><d2l-dropdown id="selectMenu"><paper-avatar id="avata" class="d2l-dropdown-opener" label="[[user.displayName]]" src="[[user.photoURL]]"></paper-avatar><d2l-dropdown-content no-padding="no-padding" no-auto-fit="no-auto-fit" align="end"><menu-sidebar></menu-sidebar></d2l-dropdown-content></d2l-dropdown><div id="menubar"></div><paper-fab icon="add" disabled="[[!online]]" class="blue" on-tap="excuteNewDevice"></paper-fab></template><script>let hotelMarkerManager,busMarkerManager,geoMarker;class MapsPage extends Polymer.mixinBehaviors([Polymer.AppNetworkStatusBehavior,Polymer.FirebaseDeviceHelper,Polymer.FirebaseDataHelper,Polymer.UnicodeSignHelper],Polymer.Element){static get is(){return'maps-page'}static get observers(){return['_getDeviceGroupObserver(appName, user)','_getGeoMarkerObserver(scriptReady, user,longitude,latitude)','_getLiveObserver(appName, user,mapReady,devicePath)','mapMarkersChanged(persistedMarkersData.splices)']}static get properties(){return{rootPath:String,user:{type:Object},appName:{type:String},devicePath:{type:String,value:'user_devices'},deviceOwner:{type:String},mapReady:{type:Boolean,notify:!0,value:!1},liveReady:{type:Boolean,notify:!0,value:!1},updateReady:{type:Boolean,notify:!0,value:!1},scriptReady:{type:Boolean,notify:!0,value:!1},groupDevice:{type:Array,notify:!0,value(){return[]}},persistedMarkersData:{type:Array,value(){return[]}},showDevices:{type:Array},iconMarker:{type:String,value:'/static/images/dashboard/busmarker_blue.png'},homeMarker:{type:Object,notify:!0},map:{type:Object,notify:!0,value:null},longitude:{type:Number,notify:!0},latitude:{type:Number,notify:!0},mapStyles:{type:Array,value(){return[{elementType:'geometry',stylers:[{color:'#eceff1'}]},{elementType:'labels',stylers:[{visibility:'off'}]},{featureType:'administrative',elementType:'labels',stylers:[{visibility:'on'}]},{featureType:'road',elementType:'geometry',stylers:[{color:'#cfd8dc'}]},{featureType:'road',elementType:'geometry.stroke',stylers:[{visibility:'off'}]},{featureType:'road.local',stylers:[{visibility:'off'}]},{featureType:'water',stylers:[{color:'#b0bec5'}]}]}}}}constructor(){super()}ready(){super.ready(),window.addEventListener('notify-error',(a)=>this.showNotificationError(a)),window.addEventListener('notify-message',(a)=>this.showNotificationMessage(a)),window.addEventListener('in-dialog-confirm',(a)=>this.inDialogConfirmHandle(a)),window.addEventListener('device-menu-option',(a)=>this.deviceMenuOption(a)),window.addEventListener('list-device-hide',(a)=>this.excuteHideListDevice(a))}mapMarkersChanged(){hotelMarkerManager&&hotelMarkerManager.update(this.persistedMarkersData)}connectedCallback(){super.connectedCallback()}disconnectedCallback(){super.disconnectedCallback();var a=firebase.app(this.appName).database();a.ref('geo_devices').off(),a.ref('user_devices').child(this.user.uid).off(),a.ref('public_devices').off(),this.liveReady=!1,this.updateReady=!1}changeMapsDevice(){var a=firebase.app(this.appName).database();a.ref('geo_devices').off(),a.ref('user_devices').child(this.user.uid).off(),a.ref('public_devices').off(),console.log('changeMapsDevice:'),console.log(this.data),this.data.forEach((b)=>{var c=a.ref('geo_devices').child(b.id);c.off()}),this.splice('data',0,this.data.length),busMarkerManager&&busMarkerManager.clear()}resetMapsData(){geoMarker&&(console.log('delete geoMarker'),geoMarker.setMap(null));var a=firebase.app(this.appName).database();a.ref('geo_devices').off(),a.ref('user_devices').child(this.user.uid).off(),a.ref('public_devices').off(),this.liveReady=!1,this.updateReady=!1,this.$.menubar.hidden=!0;var b=this.shadowRoot.querySelector('list-device');null===b||(b.user=this.user,b.appName=this.appName,b.devicePath='',this.$.menubar.removeChild(b)),this.data.forEach((b)=>{var c=a.ref('geo_devices').child(b.id);c.off()}),this.splice('data',0,this.data.length),this.splice('groupDevice',0,this.groupDevice.length),hotelMarkerManager&&hotelMarkerManager.clear(),busMarkerManager&&busMarkerManager.clear()}_getDeviceGroupObserver(a,b){a!==void 0&&b!==void 0&&b.uid&&this._firebaseGetDeviceGroup(b)}_getGeoMarkerObserver(a,b,c,d){a!==void 0&&b!==void 0&&c!==void 0&&d!==void 0&&b.uid&&a&&c&&d&&this.getGeoMarker()}_getLiveObserver(a,b,c){a!==void 0&&c!==void 0&&b!==void 0&&!1===this.updateReady&&!0===c&&a&&b.uid&&(this._firebaseGetUpdate(),this.updateReady=!0)}showNotificationError(a){this.$.notifications.showError(a.detail)}showNotificationMessage(a){this.$.notifications.showNotification(a.detail)}inDialogConfirmHandle(a){this._firebaseAddDeviceGroup(this.user,a.detail)}deviceConfirm(a){var b=a.detail.action,c=a.detail.device;'new'===b?this._firebaseAddDevice(this.user,c):'edit'===b?this._firebaseEditDevice(this.user,c):'delete'===b&&this._firebaseDeleteDevice(this.user,c)}deviceMenuOption(a){var b=a.detail.item_option,c=a.detail.item_index,d=this.get(['data',c]);'edit'===b?(this.$.deviceDialog.isEdit=!0,this.$.deviceDialog.actionTitle='Edit device',this.$.deviceDialog.openEditDialog(d)):'show'===b?this._firebaseShowDevice(this.user,d,!0):'hide'===b&&this._firebaseShowDevice(this.user,d,!1)}getGeoMarker(){console.log('Add geoMarker');var a=document.createElement('profile-marker');a.avata=this.user.photoURL,google.maps.event.addDomListener(a,'click',function(){google.maps.event.trigger(this.animationMarker(a),'click')}.bind(this));var b=new google.maps.LatLng(this.latitude,this.longitude);geoMarker=new RichMarker({position:b,map:this.map,flat:!0,content:a})}onMapClick(a){console.log('onMapClick:');var b=[a.detail.latLng.lat(),a.detail.latLng.lng()];console.log(b)}onMapReady(){console.log('onMapReady'),this.map=this.shadowRoot.querySelector('google-map').map,hotelMarkerManager=new HotelMarkerManager(this.map),busMarkerManager=new BusMarkerManager(this.map),hotelMarkerManager&&hotelMarkerManager.update(this.persistedMarkersData),Polymer.importHref(this.resolveUrl('../views/rich-marker-script.html'),function(){console.log('import successful'),this.scriptReady=!0}.bind(this),function(){console.log('import error')}.bind(this)),this.mapReady=!0}animationMarker(a){a.animateWobble()}geocodeAddress(a,b,c,d){const e=new google.maps.Geocoder;e.geocode({address:a},(a,e)=>{if('OK'===e){new google.maps.Marker({map:b,position:a[0].geometry.location,icon:{url:c,scaledSize:new google.maps.Size(32,32),anchor:new google.maps.Point(0,32)},title:d})}else console.log('Geocode was not successful for the following reason: '+e)})}excuteNewDevice(){this.$.deviceDialog.isEdit=!1,this.$.deviceDialog.actionTitle='Add device',this.$.deviceDialog.openDialog()}excuteShowListDevice(a){var b='',c=!0,d='unknow';'my_device'===a?(d='My device',this.changeMapsDevice(),this.devicePath='user_devices',this._firebaseGetUpdate(this.devicePath),b=this.devicePath+'/'+this.user.uid,c=!0):'public_device'===a&&(d='Public device',this.changeMapsDevice(),this.devicePath='public_devices',this._firebaseGetUpdate(this.devicePath),b=this.devicePath,c=!1),console.log(a);var e=this.shadowRoot.querySelector('list-device');if(null!==e)e.devicePath=b,e.showOptionMenu=c,e.title=d,e.user=this.user,e.appName=this.appName,this.$.menubar.hidden=!1,this.$.selectMenu.toggleOpen(!0);else{var e=document.createElement('list-device');e.devicePath=b,e.showOptionMenu=c,e.title=d,e.user=this.user,e.appName=this.appName,this.$.menubar.appendChild(e),this.$.menubar.hidden=!1,this.$.selectMenu.toggleOpen(!0)}}excuteHideListDevice(){this.$.menubar.hidden=!0;var a=this.shadowRoot.querySelector('list-device');a.devicePath='',this.splice('data',0,this.data.length),this.$.menubar.removeChild(a)}_firebaseGetLiveDevice(a){console.log('_firebaseGetLiveDevice');var b=firebase.app(this.appName).database();this.deviceOwner=a.owner,console.log('deviceOwner:'+this.deviceOwner);var c=b.ref('geo_devices').child(a.id);c.off(),c.on('value',function(b){return b.val()?void(busMarkerManager&&busMarkerManager.updateMarker(a,b.val())):(this.$.notifications.showError(a.name+' has not location updated!'),void this._firebaseShowDevice(this.user,a,!1))}.bind(this),function(a){console.log('The read failed: '+a.code)})}_firebaseUpdateLiveDevice(a){console.log('_firebaseUpdateLiveDevice');var b=firebase.app(this.appName).database(),c=b.ref('geo_devices').child(a.id);c.off(),c.on('value',function(b){return b.val()?void(busMarkerManager&&busMarkerManager.updateMarker(a,b.val())):(this.$.notifications.showError(a.name+' has not location updated!'),void this._firebaseShowDevice(this.user,a,!1))}.bind(this),function(a){console.log('The read failed: '+a.code)})}_firebaseRemoveLiveDevice(a){console.log('_firebaseRemoveLiveDevice');var b=firebase.app(this.appName).database(),c=b.ref('geo_devices').child(a.id);c.off(),busMarkerManager&&busMarkerManager.deleteMarker(a)}_firebaseGetUpdate(){console.log('_firebaseGetUpdate:'+this.devicePath);var a=firebase.app(this.appName).database();a.ref('user_devices').child(this.user.uid).off(),a.ref('public_devices').off(),this.splice('data',0,this.data.length);var b;'user_devices'===this.devicePath?b=a.ref('user_devices').child(this.user.uid):'public_devices'===this.devicePath&&(b=a.ref('public_devices')),b.on('child_added',function(a,b){console.log('device_added'),this.__onFirebaseChildAdded(a,b),a.val().show&&this._firebaseGetLiveDevice(a.val())}.bind(this)),b.on('child_changed',function(a){console.log('device_changed'),this.__onFirebaseChildChanged(a),this._firebaseUpdateLiveDevice(a.val())}.bind(this)),b.on('child_removed',function(a){console.log('device_removed'),this.__onFirebaseChildRemoved(a),this._firebaseRemoveLiveDevice(a.val())}.bind(this))}}class HotelMarkerManager{constructor(a){this.map=a,this.hotelMarkers=[]}add(a,b,c){const d=new google.maps.Marker({position:a,map:this.map,icon:{url:b,scaledSize:new google.maps.Size(32,32),anchor:new google.maps.Point(0,32)},title:c});this.hotelMarkers.push(d)}clear(){this.hotelMarkers.forEach((a)=>{console.log('delete sponsor:'+a.title),a.setMap(null)}),this.hotelMarkers.length=0}update(a){this.clear(),a.forEach((a)=>{console.log('add sponsor:'+a.name),this.add({lat:a.lat,lng:a.lng},a.iconPath,a.name)})}}class SmoothlyMarkerManager{constructor(a,b){this.marker=a,this.position=b,this.numDeltas=50,this.delay=5,this.i=0}transition(a){this.i=0,this.deltaLat=(a[0]-this.position[0])/this.numDeltas,this.deltaLng=(a[1]-this.position[1])/this.numDeltas,this.moveMarker()}moveMarker(){this.position[0]+=this.deltaLat,this.position[1]+=this.deltaLng;var a=new google.maps.LatLng(this.position[0],this.position[1]);this.marker.setPosition(a),this.i!=this.numDeltas&&(this.i++,setTimeout(function(){this.moveMarker()}.bind(this),this.delay))}}class BusMarkerManager{constructor(a){this.map=a,this.busLocationMarkers={},this.smoothlyMarkers={},this.markers=[]}clear(){for(const a of Object.keys(this.smoothlyMarkers)){const b=this.smoothlyMarkers[a].marker;console.log('delete:'+b.title),b.setMap(null),delete this.smoothlyMarkers[a]}}addMarker(a,b){const c=a.id;if(console.log('addMapMarker:'+c),c in this.smoothlyMarkers)return void console.log('key in this.smoothlyMarkers:'+c);if(b.l){console.log('Add marker:'+a.name);const d=a.icon,e=new google.maps.Marker({position:{lat:b.l[0],lng:b.l[1]},map:this.map,icon:{url:d,scaledSize:new google.maps.Size(29,40),anchor:new google.maps.Point(0,32)},title:a.name}),f=new SmoothlyMarkerManager(e,b.l);this.smoothlyMarkers[c]={marker:e,smoothly:f}}else console.log('Not location marker:'+a.name)}updateMarker(a,b){const c=a.id;if(console.log('updateMapMarker:'+c),!a.show)this.deleteMarker(a);else if(c in this.smoothlyMarkers){const d=this.smoothlyMarkers[c].marker,e=this.smoothlyMarkers[c].smoothly;console.log('Move old marker:'+d.title);const f=a.icon,g={url:f,scaledSize:new google.maps.Size(29,40),anchor:new google.maps.Point(0,32)};d.setIcon(g),d.setTitle(a.name),e.transition(b.l)}else console.log('Add and move new marker:'+a.name),this.addMarker(a,b)}deleteMarker(a){const b=a.id;if(console.log('deleteMapMarker:'+b),b in this.smoothlyMarkers){const a=this.smoothlyMarkers[b].marker;a.setMap(null),console.log('delete Marker:'+a.title),delete this.smoothlyMarkers[b]}}updateSmoothly(a){for(let b in this.smoothlyMarkers)if(null===a||!(b in a)){const a=this.smoothlyMarkers[b].marker;a.setMap(null),delete this.smoothlyMarkers[b]}for(let b in a){const c=a[b];if(b in this.smoothlyMarkers){const a=this.smoothlyMarkers[b].marker,d=this.smoothlyMarkers[b].smoothly;console.log('Move old marker:'+a.title);const e=c.icon,f={url:e,scaledSize:new google.maps.Size(29,40),anchor:new google.maps.Point(0,32)};a.setIcon(f),d.transition(c.l)}else{console.log('Add new marker:'+c.g);const a=c.icon,d=new google.maps.Marker({position:{lat:c.l[0],lng:c.l[1]},map:this.map,icon:{url:a,scaledSize:new google.maps.Size(29,40),anchor:new google.maps.Point(0,32)},title:c.g}),e=new SmoothlyMarkerManager(d,c.l);this.smoothlyMarkers[b]={marker:d,smoothly:e}}}}update(a){for(let b in this.busLocationMarkers)if(null===a||!(b in a)){const a=this.busLocationMarkers[b];a.setMap(null),delete this.busLocationMarkers[b]}for(let b in a){const c=a[b];if(b in this.busLocationMarkers){const a=this.busLocationMarkers[b],d=c.icon,e={url:d,scaledSize:new google.maps.Size(29,40),anchor:new google.maps.Point(0,32)};a.setIcon(e),a.setPosition({lat:c.l[0],lng:c.l[1]})}else{const a=c.icon,d=new google.maps.Marker({position:{lat:c.l[0],lng:c.l[1]},map:this.map,icon:{url:a,scaledSize:new google.maps.Size(29,40),anchor:new google.maps.Point(0,32)},title:c.g});this.busLocationMarkers[b]=d}}}}window.customElements.define(MapsPage.is,MapsPage);</script></dom-module></body></html>